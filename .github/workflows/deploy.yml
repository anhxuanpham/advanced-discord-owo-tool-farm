name: Deploy to Servers

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup SSH
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo -e "Host *\n\tStrictHostKeyChecking no\n\tUserKnownHostsFile=/dev/null\n" >> ~/.ssh/config

      - name: Deploy to Server 1 (143.198.212.100)
        run: |
          ssh -i ~/.ssh/deploy_key root@143.198.212.100 'cd ~/advanced-discord-owo-tool-farm && git pull origin main && docker-compose up -d --build --force-recreate && docker image prune -f'
          echo "âœ… Server 1 deployed!"

      - name: Deploy to Server 2 (34.158.63.223)
        run: |
          ssh -i ~/.ssh/deploy_key William@34.158.63.223 "sudo bash -c 'cd /root/advanced-discord-owo-tool-farm && git pull origin main && docker-compose up -d --build --force-recreate && docker image prune -f'"
          echo "âœ… Server 2 deployed!"

      - name: Deploy to Server 3 (34.126.130.69)
        run: |
          ssh -i ~/.ssh/deploy_key William@34.126.130.69 "sudo bash -c 'cd /root/advanced-discord-owo-tool-farm && git pull origin main && docker-compose up -d --build --force-recreate && docker image prune -f'"
          echo "âœ… Server 3 deployed!"

      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          COMMIT_SHA=$(git rev-parse --short HEAD)
          
          curl -s -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"ðŸš€ Deploy Complete (GitHub Actions)\", \"description\": \"All 3 servers updated successfully.\", \"color\": 5763719, \"fields\": [{\"name\": \"Commit\", \"value\": \"\`${COMMIT_SHA}\` ${COMMIT_MSG}\", \"inline\": false}]}]}" \
            "$DISCORD_WEBHOOK_URL"
          
          echo "ðŸ“¨ Discord notification sent!"

