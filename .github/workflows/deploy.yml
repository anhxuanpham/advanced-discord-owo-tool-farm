name: Deploy to Servers

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Disable Host Key Checking
        run: |
          mkdir -p ~/.ssh
          echo -e "Host *\n\tStrictHostKeyChecking no\n\tUserKnownHostsFile=/dev/null\n" >> ~/.ssh/config

      - name: Notify Deploy Started
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          COMMIT_SHA=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=format:'%an')
          
          curl -s -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"üöÄ Deploy Started\", \"description\": \"Deploying to 3 servers...\", \"color\": 16776960, \"fields\": [{\"name\": \"Commit\", \"value\": \"[\`${COMMIT_SHA}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) ${COMMIT_MSG}\", \"inline\": false}, {\"name\": \"Author\", \"value\": \"${AUTHOR}\", \"inline\": true}, {\"name\": \"Workflow\", \"value\": \"[View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": true}], \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
            "$DISCORD_WEBHOOK_URL"

      - name: Deploy to Server 1 (143.198.212.100)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          ssh root@143.198.212.100 'cd ~/advanced-discord-owo-tool-farm && git pull origin main && docker-compose up -d --build --force-recreate && docker image prune -f'
          
          curl -s -H "Content-Type: application/json" \
            -d '{"embeds": [{"title": "‚úÖ Server 1 Deployed", "description": "`143.198.212.100` updated successfully", "color": 5763719}]}' \
            "$DISCORD_WEBHOOK_URL"

      - name: Deploy to Server 2 (34.158.63.223)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          ssh William@34.158.63.223 "sudo bash -c 'cd /root/advanced-discord-owo-tool-farm && git pull origin main && docker-compose up -d --build --force-recreate && docker image prune -f'"
          
          curl -s -H "Content-Type: application/json" \
            -d '{"embeds": [{"title": "‚úÖ Server 2 Deployed", "description": "`34.158.63.223` updated successfully", "color": 5763719}]}' \
            "$DISCORD_WEBHOOK_URL"

      - name: Deploy to Server 3 (34.126.130.69)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          ssh William@34.126.130.69 "sudo bash -c 'cd /root/advanced-discord-owo-tool-farm && git pull origin main && docker-compose up -d --build --force-recreate && docker image prune -f'"
          
          curl -s -H "Content-Type: application/json" \
            -d '{"embeds": [{"title": "‚úÖ Server 3 Deployed", "description": "`34.126.130.69` updated successfully", "color": 5763719}]}' \
            "$DISCORD_WEBHOOK_URL"

      - name: Send Final Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          COMMIT_SHA=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=format:'%an')
          
          curl -s -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"üéâ Deploy Complete\", \"description\": \"All 3 servers updated successfully!\", \"color\": 5763719, \"fields\": [{\"name\": \"üìù Commit\", \"value\": \"[\`${COMMIT_SHA}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) ${COMMIT_MSG}\", \"inline\": false}, {\"name\": \"üë§ Author\", \"value\": \"${AUTHOR}\", \"inline\": true}, {\"name\": \"üîó Workflow\", \"value\": \"[View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": true}, {\"name\": \"üìä Servers\", \"value\": \"‚Ä¢ 143.198.212.100\\n‚Ä¢ 34.158.63.223\\n‚Ä¢ 34.126.130.69\", \"inline\": false}], \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"footer\": {\"text\": \"GitHub Actions\"}}]}" \
            "$DISCORD_WEBHOOK_URL"
